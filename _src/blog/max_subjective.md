---
date: 2017-03-03
layout: blog.hbs
title: cycling'74 Maxで評価実験のパッチを作る
permalink: max_subjective
draft: true
---

先日身内向けにMaxの基礎講座＋Maxで作る評価実験用のパッチの作り方をやったので、その資料も兼ねてここに置いておきます。

内容は主に[Puredataでの評価実験パッチ](https://matsuuratomoya.com/blog/2016-04-27/puredata-subjective-test/)作りで書いたものとほぼ同じです。

csvファイルの書き込み方やプレゼンテーションモードが異なる部分ですので参考にしていただければと思います。

<!-- more -->

# 本題の前に（型のお話）

さて、最初にMaxを使う場合（特にPdから入った場合）まずつまずきやすいのは**型の問題**です。

具体的に言うとPuredataと比べてMaxは計算の数字の型、整数(integer)と小数点(float)の扱い方が厳密です。
Puredataは数字は基本全てfloat（32bit小数）型として扱われていて、intオブジェクトもあるものの整数になるように**切り捨てているだけで中身はfloat**だったりします。

一方Maxでは計算オブジェクトに引数を指定しないと整数型の計算として扱われて、小数点型を入力しても整数に切り捨てられます。

引数を指定しても整数で割る場合は同様です。では2でわりたいけど小数点で扱いたいときはどうするかというと、2.0を略して2.と表記します。

ここを理解したらとりあえず本題に入りましょう。


# 仮の実験内容

今回はPdの時同様架空の**「ステレオ音源の音像幅を狭めた時の印象評価」**という実験用パッチを作ってみます。

この実験では「元の音源を3種類」「ステレオの音像幅を100%、75%、50%、25%」に変化させたのをそれぞれの元音源と比較して（つまり100%は変化なし）、それぞれの「音像幅、包まれ感、空間の広がり」がどのくらい変化したかを回答してもらうとします。

これが統計の評価的に妥当な実験かどうかはとりあえず無視して、実際の制作に役立ちそうな部分だけを寄せ集めたものだと思ってください。

# パラメーターの洗い出し

実験用パッチを作るにあたって最初にパラメーターが何種類あるかを洗い出します。

今回は「元の音源を3種類」「ステレオの音像幅を100%、75%、50%、25%に変化させる」でした。
ということは今回は12種類の比較があるわけです。

## パラメーターを順列に対応させる

まずはこの全パターンを1~12の番号に1つずつ割り振ります。

具体的にはこのような感じです。**剰余**と**商**（整数での割り算の答え）をうまく使いましょう。

<img src="{{config.root}}assets/img/pd_subjective/patch1.png" alt="" style = "width:300px;">

さて、これに加えて「音量を+2、+1、±0、-1、−2、-3dB変化させる」というパラメーターを加えたくなった場合はどうでしょう（妥当性があるかは相変わらず無視です）。

こんな感じですね。

<img src="{{config.root}}assets/img/pd_subjective/patch4.png" alt="" style = "width:300px;">

実際に数値はArgumentに書くか右インレットに入れるかのどちらかでよいので、次の内どちらでも良いです。

<img src="{{config.root}}assets/img/pd_subjective/patch2.png" alt="" style = "width:300px;">
<img src="{{config.root}}assets/img/pd_subjective/patch3.png" alt="" style = "width:300px;">

前者のほうがコンパクトなので今回はこちらにします。

これで、0~71の順列に対応した組み合わせが吐き出されるようになります。

# ランダムに出力する

これを回答時はランダムに出題する用にしたいです。

乱数を使うのが良さそうですが被りを無くランダムに出力したい場合は普通のrandomオブジェクトではダメです。

今回はurnオブジェクトというのがあるのでそれを使いましょう。

urnオブジェクトは右インレットに指定した数が72なら、0~71の数字を左インレットにbangが来る度重複なくランダムに出力して、73回目以降は数字を吐かず右アウトレットにbangを吐いてくれます。

# 信号処理部分

この辺は本当に実験内容によりけりなのでサクッと行きます。各パラメーターを受け取ってselで実際の値にマッピング、実際の処理に反映。

音源再生にはMaxだと幾つか方法がありますが、一番簡単なのは\[playlist~\]を使ってしまうことです。使いたい音源をドラッグドロップすれば、2を送れば上から2番めの音源が再生される、というような感じです。
ただし

1. ループの範囲などを指定したい場合はもう少し工夫が必要になります。
2. パッチを別の場所や別のPCに移動した場合音源ファイルが行方不明になる可能性が高いです。MaxProjectを使えば解決できる可能性もありますが手動でドロップしなおすほうが早いかもしれません。

# CSVに記録する部分を作る

[Puredataでの評価実験パッチ](https://matsuuratomoya.com/blog/2016-04-27/puredata-subjective-test/)でPdの利点としてMaxではCSVファイルに記録することが出来ないと書きましたが_出来ました_。

やり方としては入力したいリストを一度\[listfunnnel\]で分解、リストの要素ごとにカンマを挟んでいき、最後の要素の後に改行を追加するようにします。この部分をサブパッチにまとめておくと楽です。
そうすると一行ごとにカンマ区切りのテキストが入力でき、後は保存時の拡張子を.csvにすれば終わりです。

今回の場合は、リセット時に内容をすべてクリア、ヘッダーを入力し、**問題番号・それぞれのパラメーター、それぞれの回答**を一つのリストにまとめてから先程のサブパッチに投げるようにしましょう。

<small>ちなみにこの\[text\]オブジェクトでのやり方をPdでも出来ないかと思ったんですがPdのtextオブジェクトは(とくにv0.47から？)Maxと結構仕様が違う上カンマのエスケープがどうしても出来ないので無理でした。半角スペース区切り＋セミコロン改行なのでテキストファイルに出力してからバッチなりシェルスクリプトなりで処理してやれば可能ですが。。。</small>


# UIを作る(プレゼンテーションモード)

さて、Maxで便利なのはやはりプレゼンテーションモードで、GUIの並べる見た目を気にせずに実際のパッチのレイアウトができるところです。



