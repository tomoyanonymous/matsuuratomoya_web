<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/tomorrow.min.css">
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
    <link rel="canonical" href="http://matsuuratomoya.com">
    <meta name="viewport" content="width=700, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta property="og:type" content="website" />
    <meta name="keyword" content="松浦知也,マツウラトモヤ,Matsuura Tomoya,Tomoya Matsuura,まつうらともや">
  <meta name="description" content="Faustのライブラリの使い方と標準ライブラリのオススメ">
  <meta property="og:title" content="Matsuura Tomoya|松浦知也" />
  <meta property="twitter:card" content="summary" />
  <meta property="twitter:site" content="@tomoya_nonymous">
    <meta property="twitter:creator" content="@tomoya_nonymous">
    <meta property="twitter:creator:id" content="@tomoya_nonymous">
<meta property="og:url" content="https://matsuuratomoya.com/" />
<meta property="og:image" content="/assets/img/image_ogp.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="fb:app_id" content="1756749324544053" />
  <meta property="og:description" content="Faustのライブラリの使い方と標準ライブラリのオススメ"/>
    <title>Faustのライブラリの使い方と標準ライブラリのオススメ Matsuura Tomoya|松浦知也 </title>
  </head>

<body>
  
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-KSWGLR"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KSWGLR');</script>


  <div class="outer">

    
<header>
  <div>
      <a href="https://matsuuratomoya.com/"><div class="title">Matsuura Tomoya</div></a>

      <div class="menu">
        
        
        <a href="https://matsuuratomoya.com/about"><div >about</div></a>
        
        <a href="https://matsuuratomoya.com/info"><div >info</div></a>
        
        <a href="https://matsuuratomoya.com/works"><div >works</div></a>
        
        <a href="https://matsuuratomoya.com/blog"><div >blog</div></a>
        
        <a href="https://matsuuratomoya.com/contact"><div >contact</div></a>
        
      </div>
    <div class="locales">
      
    </div>

    <div class="social">
      <div class="tw">
  <div class="logo">
    <a href="https://twitter.com/tomoya_nonymous" target=”_blank”>
      <img src="/assets/img/tw.png" alt="twitter">
    </a>
  </div>
  </div>
  <div class="fb">
    <div class="logo">
      <a href="https://www.facebook.com/tomoya.matsuura.98" target=”_blank”>
        <img src="/assets/img/fb.png" alt="facebook">
      </a>
    </div>
  </div>

  <div class="github">
    <div class="logo">
      <a href="https://github.com/tomoyanonymous" target=”_blank”>
        <img src="/assets/img/github.png" alt="github">
      </a>
    </div>
  </div>

  <div class="instagram">
    <div class="logo">
      <a href="https://www.instagram.com/tomoya_nonymous" target=”_blank”>
        <img src="/assets/img/instagram.png" alt="instagram">
      </a>
    </div>
  </div>

    </div>
    </div>
</header>

    <div class="inner">
      <div class="child">

        <div class="content">
          <p class="date">Thu, Jan 19, 2017</p>
          <p class="title"><a href="https://matsuuratomoya.com/blog/2017-01-19/faust%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%A8%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1/">Faustのライブラリの使い方と標準ライブラリのオススメ</a></p>
          <div class="markdown">
            <p><em>この記事は<a href="http://qiita.com/advent-calendar/2016/faust">Faust(多分ひとり)Advent Calender</a>の5つ目の記事です。</em></p>

<p>本日はFaustの外部ソースの取り込み方の説明と、標準でついてくるライブラリの中から使える関数を幾つか紹介しようと思います。</p>

<p></p>

<h1 id="外部関数の読み込み">外部関数の読み込み</h1>

<p>Faustにはライブラリを定義して別のファイルから呼び出しできる機能があります。</p>

<p>具体的には</p>

<pre><code class="language-java">environment{}
library()
component()
import()
</code></pre>

<p>の４つです。</p>

<h2 id="environment">environment{}</h2>

<p>Javascriptのオブジェクトがイメージ的には近いです。幾つかの関数をグルーピングしたものを定義できて、ドットを使ってアクセスすることが出来ます。</p>

<pre><code class="language-java">parameter = environment{
                        gain = 0.2;
                        offset = 0.3;
                        };

process = _:*(parameter.gain):+(parameter.offset);
</code></pre>

<p>ソースコードを見やすくするために使っていく感じになるでしょう。</p>

<h2 id="library">library()</h2>

<p>libraryは、ある外部ファイルの中で関数を幾つか定義しておいて、それを一つのenvironmentとして呼び出せるものです。</p>

<p>この場合、呼び出せるのは<strong>.dspの普通のソースファイル</strong>と<strong>process=hogehoge が定義されてない.libのライブラリファイル</strong>のどちらもです。</p>

<pre><code class="language-java">// in parameter.lib
gain = 0.2;
offset = 0.3;

// in main.dsp

param = library(&quot;./parameter.lib&quot;);

process =  _:*(param.gain):+(param.offset);

</code></pre>

<h2 id="component">component()</h2>

<p>componentは、.dspで定義されたエフェクターをそのままソースの中で部品として使えるものです。<strong>呼び出せるのは.dspファイルのみです。</strong></p>

<pre><code class="language-java">// in gainoffset.dsp
gain = 0.2;
offset = 0.3;

process = _:*(gain):+(offset);

// in main.dsp

g_o = component(&quot;gainoffset.dsp&quot;);

process =  _:g_o:hbargraph(&quot;meter&quot;,-1,1);

</code></pre>

<p>実は、library()はprocessを呼び出すこともできるので、以下のように置換可能です。</p>

<pre><code class="language-java">// in main.dsp

g_o = library(&quot;gainoffset.dsp&quot;).process;

process =  _:g_o:hbargraph(&quot;meter&quot;,-1,1);

</code></pre>

<h2 id="import">import()</h2>

<p>importは他ファイルの名前空間を自分のファイルの中に呼び出せるものです。</p>

<p>外部ファイルのソースをそのまま自分のファイルの中に展開すると考えた方がわかりやすいかもしれません。</p>

<p>そのため、process=を含んでいるdspファイルを呼び出すとprocessが重複してしまうため、<strong>基本的には呼び出せるのは.libファイルのみです。</strong></p>

<p>ただ、コンパイラは特に拡張子関係なくファイルを開くので.dspファイルの中でprocess=を定義しなかったりすればその限りではありませんが、ファイル一覧をパッと見たときに役割が分かる用に.libと.dspを分けておくのが良いと思います。</p>

<pre><code class="language-java">// in gainoffset.lib
gain = 0.2;
offset = 0.3;

mygainoffset = _:*(gain):+(offset);

// in main.dsp

import(&quot;gainoffset.lib&quot;);

process =  _:mygainoffset:hbargraph(&quot;meter&quot;,-1,1);

</code></pre>

<p>ちなみに、Faustの中で数少ない=で結ばない構文です（この他はメタデータを定義するdeclareくらいだと思います）。</p>

<p>唯一微妙なのはatomで編集していると.libには最初に開いた時にシンタックスハイライトが適用されないので手動で適用し直さないといけないところでしょうか。</p>

<h1 id="標準ライブラリ-stdfaust-lib">標準ライブラリ stdfaust.lib</h1>

<p>さて、実は2016年10月頃にfaustはライブラリのシステムが大きく変わりました。</p>

<p>それ以前はmusic.lib、filter.libなど7~8個のライブラリファイルが同梱されていて、それを使う時にimportする形でしたが、今は標準ライブラリを呼び出すときはこの一文だけで大丈夫です。</p>

<pre><code class="language-java">import(&quot;stdfaust.lib&quot;);
</code></pre>

<p>どういうことかというと、stdfaust.libの中身はこうなっています。</p>

<pre><code class="language-java">//################################ stdfaust.lib ##########################################
// The purpose of this library is to give access to all the Faust standard libraries
// through a series of environment.
//########################################################################################

ma = library(&quot;math.lib&quot;);
ba = library(&quot;basic.lib&quot;);
de = library(&quot;delay.lib&quot;);
en = library(&quot;envelope.lib&quot;);
ro = library(&quot;route.lib&quot;);
si = library(&quot;signal.lib&quot;);
an = library(&quot;analyzer.lib&quot;);
fi = library(&quot;filter.lib&quot;);
os = library(&quot;miscoscillator.lib&quot;);
no = library(&quot;noise.lib&quot;);
ho = library(&quot;hoa.lib&quot;);
sp = library(&quot;spat.lib&quot;);
sy = library(&quot;synth.lib&quot;);
ef = library(&quot;misceffect.lib&quot;);
co = library(&quot;compressor.lib&quot;);
ve = library(&quot;vaeffect.lib&quot;);
pf = library(&quot;phafla.lib&quot;);
re = library(&quot;reverb.lib&quot;);
pm = library(&quot;pm.lib&quot;);
dm = library(&quot;demo.lib&quot;);
</code></pre>

<p>つまり、filter.libの中の関数を呼び出すためには</p>

<pre><code class="language-java">import(&quot;stdfaust.lib&quot;);
// Q3、カットオフ周波数1000Hzバンドパスフィルターを呼び出す
process = fi.resonbp(1000,3,1.0);
</code></pre>

<p>というようになります。</p>

<p>新しいシステムでこのよう仕組みになったのは、それまでfilter.libのbandpass()を呼び出すときはいきなりbandpass()を呼び出すのですが、これが自分で定義したのか標準ライブラリで定義したのかわからなくなることが多々あったので、標準ライブラリは名前空間を独立させるようにした、ということのようです。</p>

<p>このシステム導入と同時にフィルターやオシレータ、エフェクトの種類自体も大幅に増えたのでかなり便利になりました。</p>

<p>リファレンスはこちらにあるので読んでみてください。</p>

<p><a href="http://faust.grame.fr/library.html">http://faust.grame.fr/library.html</a></p>

<p>余談ですが、このライブラリはfaust2mdという、コメントをMarkdownで組んでおくと簡単にドキュメントを出力してくれるシステムを使ってライブラリファイルから自動出力されているみたいです。</p>

<p>以下ではこの中からいくつか便利なものを紹介していこうと思います。</p>

<h2 id="signal-lib">signal.lib</h2>

<p>(記述)-&gt;(結果)という文法とは関係ない書き方をしていますのでご容赦。</p>

<p>呼び出しはsiです。</p>

<pre><code class="language-java">si.bus(5) -&gt; _,_,_,_,_

si.block(5) -&gt; !,!,!,!,!

//この２つは一番良く使うと思います。

hslider(&quot;gain&quot;,0,0,1,0.001):si.smoo //UI系のパラメータの簡単な平滑化
</code></pre>

<h2 id="basic-lib">basic.lib</h2>

<p>呼び出しはbaです。</p>

<pre><code class="language-java">
// 並列要素から取り出す系

ba.take(3,(10,20,30,40)); -&gt; 30

ba.subseq((10,20,30,40,50,60), 1, 3); -&gt; (20,30,40)

_,_,_,_ : ba.selector(2,4) : _;  // ４インプットの中から3番目を「コンパイル時に」取り出す(0からカウントなので注意)

_,_,_,_ : ba.selectn(4,2) : _;  // ４インプットの中から3番目を「実行時に」取り出す

//（selectorと2,4が逆になっているのに注意。例えばこの場合2をhsliderにしておいて実行中に変更する事ができる。）

_ : latch(clocksig) :_;//サンプルホールド。clocksigが負→正になったときサンプルする

_ : sAndH(t) : _; // 上の簡略版。tが1の時サンプル。ビット演算使ってtが0か1になるようにしておかないとおかしくなります
</code></pre>

<p>この他、sec→sampleやlinear→dbなどの単位変換などがあります。</p>

<h2 id="route-lib">route.lib</h2>

<p>ルーティング系。大規模になるほど使う機会が増えてきます。
呼び出しはro。</p>

<p>コレは多分図を見たほうが早いです。</p>

<pre><code class="language-java">import(&quot;stdfaust.lib&quot;);

crosssample = 1&lt;:ro.cross(4);

cross2sample = 2&lt;:ro.cross2; //ステレオエフェクトを２つ組み合わせる時に便利

crossnnsample = 3&lt;:ro.crossnn(4);

interleavesample =4&lt;:ro.interleave(4,2);

process = crosssample,cross2sample,crossnnsample,interleavesample;
</code></pre>

<p><img src="/assets/img/faust/routesample.svg" alt=""></p>

<h2 id="filter-lib">filter.lib</h2>

<p>フィルター系。膨大な量入っているので普通に実装の勉強になります。
ぱっと使いたい時に便利なやつを紹介。呼び出しはfiです。</p>

<pre><code class="language-java">_:fi.dcblocker:_ DCオフセット除去

fi.ff_fcomb(最大ディレイサンプル数,ディレイサンプル,ドライゲイン,ディレイ信号ゲイン) //フィードフォワードコムフィルタ。最大ディレイサンプルは2のn乗。


fi.fb_fcomb(最大ディレイサンプル数,ディレイサンプル,フィードバックゲイン,アウトプット信号ゲイン)

// シンプルなレゾナンスフィルタ（多分双二次フィルタ）

fi.resonlp(fc,Q,gain) ローパス
fi.resonhp(fc,Q,gain) ハイパス
fi.resonbp(fc,Q,gain) バンドパス

// 次数指定可なバタワースフィルタ

fi.lowpass(次数,fc)
fi.highpass(次数,fc)

//バンドパス、バンドストップは次数が偶数なので、1を指定すると２段という形になります。

fi.bandpass(次数/2,下カット周波数,上カット周波数)
fi.bandstop(次数/2,下カット周波数,上カット周波数)


//シェルビング

fi.lowshelf(次数,ゲイン,周波数)
fi.highshelf(次数,ゲイン,周波数)

//ピーキング、ディップ

peak_eq_cq(ゲイン,周波数,Q)

</code></pre>

<h2 id="noise-lib">noise.lib</h2>

<p>ノイズ、乱数系。呼び出しはno。</p>

<pre><code class="language-java">no.noise //-1~1のホワイトノイズ。

no.multinoise(n) //複数無相関ノイズを出したい場合。no.noiseを色んな所に使うと全部同じシードのノイズが出てしまいます。普通にシード指定の関数欲しい

pink_noise //ピンクノイズ。
pink_noise_vm(N) //無相関の複数ピンクノイズ。
</code></pre>

<h2 id="miscoscillator-lib">miscoscillator.lib</h2>

<p>オシレーター詰め合わせ。呼び出しはos。</p>

<pre><code class="language-java">
os.osc(freq) //最も標準なオシレータ。（インパルス＋フィルタベース）
os.oscrp(freq,phase) //位相指定できるタイプ。

os.oscs(f) //ステートバリアブルフィルタ使用のサイン波。
os.oscws(fr) //ウェーブガイドフィルタ使用のサイン波。


os.osccos(freq) //テーブル呼び出しサイン波。これが一番軽いはず。テーブルサイズは2^16。
os.oscsin(freq)
os.oscp(freq,phase) //テーブルで位相指定できるタイプ。

//以下はアンチエイリアシング入れてないのでコントロールシグナルに使うのが普通

os.lf_squarewavepos(freq) //0~1矩形波
os.lf_squarewave(freq) //-1~1矩形波
os.lf_trianglepos(freq) //-1~1三角波
os.lf_sawpos_phase(phase,freq) //0~1鋸歯状波。sinやcosの位相に突っ込むmaxでのphasor~的な奴。
os.saw1(freq) //-1~1鋸歯状波。

//アンチエイリアシング入り

os.sawNp(N,freq,phase) //-1~1鋸歯状波。Nは次数で、6まで。高いほど再現度高いけど重い

os.pulsetrainN(N,freq,duty) //デューティ比設定可のパルス波。
os.squareN(N,freq)  //矩形波。
os.triangleN(N,freq) //三角波。

</code></pre>

<h2 id="analyzer-lib">analyzer.lib</h2>

<p>グラフ表示系など。呼び出しはan。</p>

<pre><code class="language-java">// とりあえず便利なスペクトル分析。

an.mth_octave_spectral_level_default(オクターブ内の分割数,最高周波数,分割数,平滑時間,dbオフセット)

//demo.lib内のデモを試すほうがわかりやすいかもです
de.spectral_level_demo
</code></pre>

<p>こういう感じになります。</p>

<p><img src="/assets/img/faust/faust_analyzer.png" alt=""></p>

<p>これ、若干パラメータがややこしいですが</p>

<p>例えば</p>

<ul>
<li>最高周波数を16000Hz</li>
<li>オクターブ内の分割数 2</li>
<li>全体の分割数 10</li>
</ul>

<p>にした場合は、</p>

<p>16000*2^(-0/2) = 16000</p>

<p>16000*2^(-<sup>1</sup>&frasl;<sub>2</sub>) = 11313.7</p>

<p>16000*2^(-<sup>2</sup>&frasl;<sub>2</sub>) = 8000</p>

<p>16000*2^(-<sup>3</sup>&frasl;<sub>2</sub>) = 5656.9</p>

<p>16000*2^(-<sup>4</sup>&frasl;<sub>2</sub>) = 4000</p>

<p>16000*2^(-<sup>5</sup>&frasl;<sub>2</sub>) = 2828.4</p>

<p>16000*2^(-<sup>6</sup>&frasl;<sub>2</sub>) = 2000</p>

<p>16000*2^(-<sup>7</sup>&frasl;<sub>2</sub>) = 1414.2</p>

<p>16000*2^(-<sup>8</sup>&frasl;<sub>2</sub>) = 1000</p>

<p>というように計算して、下から順に</p>

<p>0~1000
1000~1414
1414~2000
2000~2828
2828~4000
4000~5656
5656~8000
8000~11313
11313~16000
16000~ナイキスト</p>

<p>という10バンドに分割します。Nが10だった場合はDC含む最低部分とナイキストまでの最高部分含めて10なので注意してください。</p>

<h1 id="次の記事では">次の記事では</h1>

<p>Faustで書いたコードの「ガワ」になる部分、Architectureファイルについて解説します。</p>

            <div class="share">
  <div class="tweet">
<a href="https://twitter.com/share" class="twitter-share-button" data-size="large" data-url="https://matsuuratomoya.com/blog/2017-01-19/faust%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%A8%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1/" data-related="tomoya_nonymous">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

<div class="fb-share-button" data-href="https://matsuuratomoya.com/blog/2017-01-19/faust%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%A8%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1/" data-layout="box_count" data-mobile-iframe="true"></div>

</div>

            <hr>

<div class="fb-comments" data-width="100%" data-href="https://matsuuratomoya.com/blog/2017-01-19/faust%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9%E3%81%A8%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1/" data-numposts="5"></div>

            <div class="pagination">

<ul>
  <li class="to_next">

    <a href=""  class="none">
        
    &lt;&lt;

    </a>

  </li>
  <li class="to_index">

    <a href="../">^</a>

  </li>
  <li class="to_prev">

    <a href="
     https://matsuuratomoya.com/blog/2017-01-07/faust%E3%81%AE%E5%9F%BA%E6%9C%AC%E6%96%87%E6%B3%95%E8%A7%A3%E8%AA%AC/
    " >

    >>
    
    Faustの基本文法解説
    
    </a>
  </li>


</ul>
</div>

          </div>
        </div>

      </div>

    </div>
    
  <footer>
<div class="child">

<p class = "copyrights">

<a href="https://matsuuratomoya.com/license">2016-2017 (CC BY-NC-ND 4.0) Matsuura Tomoya</a>
</p>
</div>
</footer>

  </div>
</body>
</html>
